# 代码高亮功能说明
## 🎯 功能概述

CodeAgent UI 现在支持专业的代码语法高亮，类似于 GitHub 的代码显示风格。

## 🔧 技术实现

### 使用的库
- **Pygments**: Python 语法高亮库
- **Flet Markdown**: 用于渲染高亮后的代码
- **GitHub Web 主题**: 模拟 GitHub 的代码显示风格

### 支持的编程语言

#### 主要语言
- ✅ **Python** (`python`) - 完全支持
- ✅ **JavaScript** (`javascript`, `js`) - 完全支持
- ✅ **Bash/Shell** (`bash`, `sh`) - 完全支持
- ✅ **PowerShell** (`powershell`, `pwsh`) - 完全支持
- ✅ **HTML** (`html`) - 完全支持
- ✅ **CSS** (`css`) - 完全支持

#### 编程语言
- ✅ **Java** (`java`) - 完全支持
- ✅ **C++** (`cpp`, `c++`) - 完全支持
- ✅ **C** (`c`) - 完全支持
- ✅ **Go** (`go`) - 完全支持
- ✅ **Rust** (`rust`) - 完全支持
- ✅ **SQL** (`sql`) - 完全支持

#### 数据格式
- ✅ **JSON** (`json`) - 完全支持
- ✅ **XML** (`xml`) - 完全支持
- ✅ **YAML** (`yaml`, `yml`) - 完全支持

#### 其他语言
- 🔧 **其他**: 尝试自动检测，如果失败则使用纯文本显示

## 🎨 显示特性

### 语法高亮
- **关键字高亮**: 语言关键字自动高亮
- **字符串颜色**: 字符串和注释有不同颜色
- **函数识别**: 函数名和变量名特殊显示
- **GitHub 风格**: 使用熟悉的 GitHub 代码主题

### 交互功能
- **代码选择**: 支持选择和复制代码
- **字体显示**: 使用等宽字体保证对齐
- **背景区分**: 代码区域有明显的背景色区分

## 📋 使用方法

### 自动语法高亮
当 AI 生成代码时，系统会自动：
1. **检测语言**: 从代码块标记识别语言类型
2. **应用语法高亮**: 使用对应的词法分析器
3. **渲染显示**: 以 GitHub 风格显示代码

### 示例代码块
```python
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

# 计算前10个斐波那契数
for i in range(10):
    print(f"fib({i}) = {fibonacci(i)}")
```

```javascript
// 异步函数示例
async function fetchData(url) {
    try {
        const response = await fetch(url);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error:', error);
    }
}
```

```bash
#!/bin/bash
# 文件批量重命名脚本
for file in *.txt; do
    mv "$file" "backup_${file}"
done
echo "Files renamed successfully!"
```

## 🔧 技术细节

### 高亮实现流程
```python
def _highlight_code(self, code: str, language: str):
    """代码高亮"""
    # 1. 检查 Pygments 可用性
    if not PYGMENTS_AVAILABLE:
        return ft.Text(code, font_family="Courier New", size=13)
    
    # 2. 获取词法分析器
    lexer = get_lexer_by_name(language)
    
    # 3. 生成高亮 HTML
    formatter = get_formatter_by_name('html', style='github')
    highlighted_code = highlight(code, lexer, formatter)
    
    # 4. 使用 Markdown 组件渲染
    return ft.Markdown(f'```{language}\n{code}\n```')
```

### 错误处理
- **库缺失**: 如果 Pygments 不可用，降级到纯文本显示
- **语言未知**: 对于不支持的语言，使用通用文本显示
- **解析错误**: 捕获并记录所有异常，确保 UI 稳定

## 🚀 安装和配置

### 安装依赖
```bash
# 激活环境
conda activate dl

# 安装 Pygments（已安装）
pip install Pygments
```

### 配置选项
- **主题**: 使用 GitHub 风格（`style='github'`）
- **行号**: 默认不显示行号（`linenos=False`）
- **CSS 类**: 使用 `highlight` 类（`cssclass='highlight'`）

## 📊 性能说明

### 高亮性能
- **轻量级**: 只在代码渲染时进行处理
- **缓存友好**: 相同代码可以复用高亮结果
- **内存优化**: 高亮后立即释放临时对象

### 用户体验
- **即时显示**: 代码高立即可见
- **响应式**: 支持窗口大小调整
- **可访问**: 支持文本选择和复制

## 🎯 未来改进

### 计划功能
- [ ] **主题切换**: 支持多种代码主题
- [ ] **行号显示**: 可选的行号显示
- [ ] **代码折叠**: 支持代码块折叠
- [ ] **复制按钮**: 一键复制代码功能
- [ ] **更多语言**: 扩展对更多语言的支持

### 扩展方式
```python
# 添加新语言支持
elif language == 'rust':
    lexer = get_lexer_by_name('rust')
elif language == 'go':
    lexer = get_lexer_by_name('go')
```

## 🎉 使用效果

现在当你在 CodeAgent UI 中输入任务时，AI 生成的所有代码都会：
1. **自动识别编程语言**
2. **应用专业的语法高亮**
3. **以 GitHub 风格显示**
4. **支持选择和复制**

这大大提升了代码的可读性和用户体验！

---

**注意**: 首次使用时如果提示 "Pygments未安装"，请运行：
```bash
conda run -n dl pip install Pygments

# CodeAgent UI 使用指南
## 🎯 项目概述

这个UI界面是为了测试和演示CodeAgent的功能而设计的。CodeAgent是一个能够生成并执行代码的AI代理，支持多种编程语言，并具有用户确认机制来确保安全性。

## 🚀 快速开始

### 1. 环境激活
```bash
conda activate dl
```

### 2. 运行基础测试
```bash
cd d:\agent4\test\code_agent_test
python test_simple.py
```

### 3. 启动UI界面
```bash
python run_ui.py
```

## 📋 功能特性

### 核心功能
- ✅ **AI聊天界面**: 类似ChatGPT的对话体验
- ✅ **流式输出**: 实时显示AI思考和生成过程
- ✅ **Markdown渲染**: 支持完整的Markdown格式显示
- ✅ **代码高亮**: 代码块语法高亮显示
- ✅ **权限控制**: 每个代码块都需要用户确认执行
- ✅ **执行结果**: 在代码块下方显示执行输出
- ✅ **图片支持**: 自动解码base64图片并显示

### 安全特性
- 🔒 **用户确认机制**: 所有代码执行都需要用户批准
- 🛑 **中断控制**: 随时停止代码执行或整个任务
- 📝 **执行日志**: 完整记录所有执行过程

## 🎮 使用流程

### 步骤1: 输入任务
在底部输入框中描述你的任务，例如：
- "创建一个Python脚本来分析数据并生成图表"
- "写一个函数来计算斐波那契数列"
- "帮我处理这个CSV文件"

### 步骤2: AI生成代码
AI会逐步分析任务并生成解决方案：
1. 显示思考过程（Markdown格式）
2. 生成代码块
3. 代码块会自动高亮并语法着色

### 步骤3: 代码执行确认
当AI生成代码后：
- 待执行的代码块会高亮显示（蓝色边框）
- 代码块右侧出现"确认执行"和"取消"按钮
- 用户可以审查代码后再决定是否执行

### 步骤4: 查看执行结果
代码执行后的结果会显示在对应代码块下方：
- 文本输出：黑色等宽字体
- 图片：自动解码并显示
- 错误信息：红色字体显示

### 步骤5: 任务完成
AI会继续执行直到任务完成，或用户主动停止。

## 🔧 技术架构

### 消息通信
Agent和UI之间通过Queue进行异步通信：
```
UI ←→ MessageQueue ←→ CodeAgent
```

### 消息格式
```json
{
  "name": "CodeAgent",
  "type": "消息类型",
  "content": "消息内容"
}
```

消息类型包括：
- `status`: 状态更新（[START]、[STOP]、[BLOCK{i}]）
- `ai_content`: AI内容流（[BEGIN]、[END]、文本片段）
- `request`: 权限请求（[BLOCK{i}]need_permission）
- `text/image/png`: 代码执行输出

### UI组件结构
```
ChatMessage
├── CodeBlock
│   ├── 代码显示区
│   ├── 控制按钮（确认/取消）
│   └── 执行结果区
└── 文本内容区
```

## 🛠️ 故障排除

### 常见问题

1. **UI无法启动**
   ```
   解决方案：
   - 确认conda环境dl已激活
   - 检查flet库是否安装：pip install flet
   - 确认Python路径配置正确
   ```

2. **API连接失败**
   ```
   解决方案：
   - 检查.env文件中的API配置
   - 确认LM Studio或其他API服务正在运行
   - 验证API地址和端口是否正确
   ```

3. **代码执行失败**
   ```
   解决方案：
   - 检查jupyter-client安装：pip install jupyter-client
   - 确认Python环境配置正确
   - 查看错误信息并调试代码
   ```

4. **图片不显示**
   ```
   解决方案：
   - 检查base64解码是否正常
   - 确认图片格式（支持PNG/JPEG）
   - 查看网络连接状态
   ```

### 调试方法

1. **启用详细日志**
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **检查消息流**
   - 观察状态消息（[START]、[BLOCK0]等）
   - 确认权限请求正常发送
   - 验证执行结果正确接收

3. **测试单个组件**
   ```bash
   # 运行简化测试
   python test_simple.py
   
   # 运行完整测试
   python test_basic.py
   ```

## 📝 使用示例

### 示例1: 数据分析任务
```
输入: "创建一个Python脚本来生成随机数据并绘制柱状图"

AI响应:
1. 生成包含matplotlib的Python代码
2. 用户确认执行
3. 显示生成的图表
4. AI确认任务完成
```

### 示例2: 文件处理任务
```
输入: "帮我读取当前目录的文件并统计大小"

AI响应:
1. 生成使用os模块的Python代码
2. 用户确认执行
3. 显示文件统计结果
4. 可能生成可视化代码
```

### 示例3: 数学计算任务
```
输入: "编写函数计算圆周率到小数点后100位"

AI响应:
1. 生成使用数学算法的代码
2. 用户确认执行
3. 显示计算结果
4. 提供性能分析
```

## 🚨 安全注意事项

1. **代码审查**: 在执行代码前务必仔细审查
2. **权限控制**: 不要随意执行不熟悉的代码
3. **环境隔离**: 建议在虚拟环境中测试
4. **数据安全**: 避免在代码中包含敏感信息

## 🔄 扩展功能

### 计划中的功能
- [ ] 代码编辑功能：允许用户修改AI生成的代码
- [ ] 执行历史：保存和查看历史执行记录
- [ ] 多语言支持：扩展更多编程语言
- [ ] 文件管理：集成文件浏览器
- [ ] 项目模板：提供常用任务模板

### 自定义开发
UI采用模块化设计，可以轻松扩展：
- 添加新的消息类型
- 自定义代码块渲染
- 集成第三方库
- 实现自定义控制逻辑

## 📞 支持与反馈

如果遇到问题或有改进建议，请：
1. 检查本指南的故障排除部分
2. 查看项目日志文件
3. 运行诊断测试
4. 提供详细的错误信息和复现步骤

---

**注意**: 这是一个测试版本，仅供学习和演示使用。在生产环境中使用前请确保充分测试。
